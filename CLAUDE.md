# CLAUDE.md

日本語で全て応答してください
このファイルは、このリポジトリでコードを扱う際のClaude Code (claude.ai/code)へのガイダンスを提供します。

## プロジェクト概要

東京駅を中心とした対話型地図を表示するMapLibre GL JSウェブアプリケーションです。現在位置取得機能、ピン配置機能、データ保存・読み込み機能に加えて、**東京都内のバリアフリートイレデータ**を統合した施設検索システムを実装した、モジュール化されたアプリケーションです。

### 主な用途

- 現在位置周辺のバリアフリートイレ施設を検索・表示
- カスタムピンによる個人的な場所の記録・管理
- 施設情報の詳細表示（設備、階数、住所など）
- オフライン対応（ローカルストレージ保存）

## アーキテクチャ

- **モジュール化アプリケーション**: ES6モジュールを使用してコードを機能別に分割
- **MapLibre GL JS**: 地図レンダリングにバージョン4.1.0を使用
- **MapTiler**: APIキーを使用してMapTilerのストリートマップタイルを使用
- **クラスベース設計**: 機能別にクラス化し、責任を分離

## ファイル構成

- `index.html` - 基本的なHTML構造、ピン配置ダイアログUI、データ読み込みUI
- `styles.css` - すべてのスタイル定義（ダイアログ、コントロールパネル含む）
- `config.js` - 設定値を一元管理
- `locationService.js` - 位置情報機能のクラス
- `pinService.js` - ピン管理機能のクラス（ダイアログ、CSV読み込み機能含む）
- `app.js` - メインアプリケーションクラス
- `utils.js` - CSV解析、距離計算、データ処理ユーティリティ
- `data/` - CSVデータファイル格納ディレクトリ
  - `barrier_free_toilets.csv` - 公共バリアフリートイレデータ
  - `station_barrier_free_toilets.csv` - 駅のバリアフリートイレデータ

## 主要コンポーネント

- **MapApp**: メインアプリケーションクラス
- **LocationService**: 現在位置取得機能を管理
- **PinService**: ピン配置・管理機能、CSV データ読み込み機能を管理
- **CONFIG**: 設定値を一元管理する設定オブジェクト
- **utils**: CSV解析、距離計算、データ処理ユーティリティ関数群

## 開発

ES6モジュールを使用しているため、以下の方法で開発できます：

- `python3 -m http.server`や`live-server`などのローカル開発サーバーを使用（モジュールのため必須）
- ビルドプロセスやパッケージ管理は不要

## 設定

すべての設定値は`config.js`で管理されています：

- **MapTiler APIキー**: 環境変数で管理（本番使用時には独自のキーを設定）
- **初期座標**: 東京駅の座標（139.767, 35.681）
- **デフォルトズームレベル**: 12
- **現在位置ズームレベル**: 15
- **マーカー色**: 現在位置（赤）、ピン（青）

## 実装済み機能

### 現在位置取得機能

**基本機能**

- ✅ 「現在位置取得」ボタンを地図上に配置（右上）
- ✅ ボタンクリック時のみGeolocation APIを実行
- ✅ 位置情報が取得できた場合、地図の中心を現在位置に移動（ズームレベル15）
- ✅ 現在位置にマーカーを表示（赤色、他のピンとは異なるスタイル）

**UI/UX**

- ✅ ボタンクリック時のローディング表示（⏳アイコン）
- ✅ 位置情報が取得できない場合のエラーメッセージ表示
- ✅ 位置情報の使用許可を求めるダイアログの適切な案内
- ✅ 既存の現在位置マーカーの自動削除・更新

### 地図上の任意の場所にピン配置機能

**基本機能**

- ✅ 地図上のクリック/タップでピン配置ダイアログを表示
- ✅ 複数のピンを同時に配置可能
- ✅ 配置されたピンの削除機能（ポップアップ内の削除ボタン）
- ✅ ピンのクリック判定とイベント競合問題を解決

**ピン配置ダイアログ機能**

- ✅ 名称入力（テキストフィールド）
- ✅ 色選択（7色：青、赤、緑、黄色、紫、オレンジ、黒）
- ✅ 備考入力（テキストエリア）
- ✅ OK/キャンセルボタン
- ✅ 背景クリックでキャンセル
- ✅ 名称入力欄への自動フォーカス

**データ保存・読み込み**

- ✅ ピン情報をローカルJSONファイル（pins.json）に保存
- ✅ ファイルダウンロード機能でJSONファイルを保存
- ✅ ファイルアップロード機能でJSONファイルを読み込み
- ✅ 拡張JSONファイル形式：`[{"id": 1, "lat": 35.681, "lng": 139.767, "name": "ピン1", "color": "#0066cc", "note": "備考"}]`
- ✅ CSV データファイルからの施設情報読み込み機能
- ✅ 現在位置から500m以内の施設データを自動フィルタリング
- ✅ 重複ピンの自動検出・防止機能

**UI/UX**

- ✅ ピンをクリック/タップでポップアップ表示（イベント競合解決済み）
- ✅ ポップアップ内に削除ボタン表示
- ✅ ピンの座標情報を表示（緯度・経度）
- ✅ 備考がある場合はポップアップ内に表示
- ✅ 全てのピンをクリア機能（🗑️ボタン）
- ✅ 「ピンを保存」ボタン（💾ボタン、JSONファイルダウンロード）
- ✅ 「ピンを読み込み」ボタン（📁ボタン、JSONファイルアップロード）
- ✅ 「近くのデータを表示」ボタン（🔍ボタン、CSV データ読み込み）
- ✅ 施設情報の詳細表示（住所、階数、設備詳細、現在位置からの距離）

**データ管理**

- ✅ 配置されたピンの座標を配列で管理
- ✅ ピンの一意識別子（ID）を付与
- ✅ ピンの追加・削除時のデータ更新
- ✅ ピンデータ構造拡張（名称、色、備考）
- ✅ ブラウザのlocalStorageにも自動保存（バックアップ）
- ✅ ページ読み込み時にlocalStorageからピンを復元

## クラス仕様

### MapApp クラス

- 地図の初期化とサービスクラスの管理
- メインアプリケーションのエントリーポイント

### LocationService クラス

- 現在位置取得機能の管理
- Geolocation APIの処理
- 現在位置マーカーの管理

### PinService クラス

- ピン配置・削除機能の管理
- ピンデータの保存・読み込み
- ファイル操作（保存・読み込み）
- ピン配置ダイアログの制御
- イベント競合の解決（stopPropagation）
- CSV データファイルの読み込み・解析
- 距離計算による施設フィルタリング
- 重複ピンの検出・防止
- 施設情報の整形・表示

## 最新の更新内容

### 2025年7月7日の更新

1. **CSV データ統合システム実装**

   - 東京都内のバリアフリートイレデータ（CSV）を統合
   - 現在位置から500m以内の施設を自動検索・表示
   - 重複ピンの自動検出・防止機能

2. **新しいユーティリティモジュール追加**

   - `utils.js`: CSV解析、距離計算（Haversine）、データ処理
   - 高精度な距離計算による施設フィルタリング
   - 最大50件の施設データ制限

3. **データ読み込み機能の実装**

   - 「近くのデータを表示」ボタン追加
   - 公共施設（緑）・駅施設（青）の色分け表示
   - 詳細な施設情報表示（住所、階数、設備、距離）

4. **UI コントロール拡張**
   - データ読み込み専用コントロールパネル追加
   - 既存のピン管理コントロールと分離
   - 施設情報の詳細ポップアップ表示

### 2025年7月6日の更新

1. **ピン配置ダイアログ機能追加**

   - 名称、色、備考を入力できるダイアログを実装
   - モーダルスタイルのUI追加

2. **ピンデータ構造の拡張**

   - `color`と`note`フィールドを追加
   - JSONファイル形式を拡張

3. **イベント競合問題の修正**

   - ピンクリック時に新しいピンが作成される問題を解決
   - `stopPropagation()`による適切なイベント制御

4. **UI/UX改善**
   - ポップアップに備考表示機能を追加
   - 色選択による視覚的な区別
   - ダイアログの使いやすさ向上

## CSV データ仕様

### データソース

- **公共施設**: `data/barrier_free_toilets.csv`
- **駅施設**: `data/station_barrier_free_toilets.csv`

### データ構造

```csv
name,address,floor,toilet_name,note,color,lng,lat
施設名,住所,階数,トイレ名,備考,色,経度,緯度
```

### 機能仕様

- **検索範囲**: 現在位置から500m以内
- **表示制限**: 最大50件
- **距離計算**: Haversine公式による高精度計算
- **重複防止**: 座標値による重複検出（10m以内）
- **色分け**: 公共施設（緑）、駅施設（青）
