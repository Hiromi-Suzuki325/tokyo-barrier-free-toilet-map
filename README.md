# Tokyo Barrier-Free Toilet Map

**東京都全域**のバリアフリートイレを検索・表示できる対話型地図アプリケーション

## 概要

MapLibre GL JS を使用して**東京都全域**をカバーした対話型地図を表示し、現在位置周辺のバリアフリートイレ施設を検索・表示できる Web アプリケーションです。23 区、多摩地域、島嶼部を含む詳細なデータベースを備え、オフライン対応のピン管理機能や、詳細な施設情報表示機能を備えています。

## 主な機能

### 📍 現在位置取得機能

- 現在位置を取得し、地図の中心を現在位置に移動
- 現在位置マーカーの表示（赤色）
- HTTPS セキュリティと位置情報許可の適切な処理

### 🚻 バリアフリートイレ検索機能

- **東京都全域**（23 区、多摩地域、島嶼部）のデータを統合管理
- 現在位置から 500m 以内のバリアフリートイレを自動検索
- 公共施設と駅施設のデータを統合表示
- **135 以上の自治体データ**を個別管理
- 距離順ソートと最大 50 件の表示制限
- 重複ピンの自動検出・防止機能

### 📍 カスタムピン管理機能

- 地図上の任意の場所にピンを配置
- ピンの名称、色（7 色）、備考の設定
- ローカルストレージによる自動保存
- JSON ファイルの保存・読み込み機能

### 📊 データ表示機能

- 施設の詳細情報表示（住所、階数、設備詳細、距離）
- モバイル: 画面下部のボトムシートで詳細表示（約50%の高さ、スクロール可）
- デスクトップ: 従来どおり MapLibre のポップアップで詳細表示
- 現在位置からの距離計算（Haversine 公式）

### 🎛️ ユーザーインターフェース

- 現在位置取得ボタン（📍）
- 北向きリセットボタン（🧭）
- バリアフリートイレ表示ボタン（スタイリッシュなデザイン）
- レスポンシブデザイン対応

#### モバイルUI（ボトムシート表示）

- 表示条件: 画面幅が 768px 以下でピンをタップしたときにボトムシートを使用
- 表示形式: 画面下から約 50dvh（≒画面の50%）でスライドイン、内容は内部スクロール
- 背景: 暗幕なし（背景は暗くしません）。地図のパン/ピンチズーム操作は継続可能
- 閉じ方: クローズボタン、外側クリック、Esc キー、地図空白クリック
- デスクトップ: 従来どおり MapLibre のポップアップを使用

#### ピン選択時のカメラ位置（モバイル）

- ピンを画面下から約 65% の位置（= 上から 35%）に来るよう、`flyTo` の `offset` を付与
- 水平方向（X）は中央のまま、垂直方向（Y）のみ上寄せ

## 技術仕様

### フロントエンド技術

- **MapLibre GL JS** v4.1.0 - 地図レンダリング
- **MapTiler API** - 地図タイルサービス
- **ES6 Modules** - モジュール化アーキテクチャ
- **Vite** - 開発・ビルドツール
- **Vanilla JavaScript** - フレームワーク非依存

### ファイル構成

```
├── index.html              # メインHTML
├── app.js                  # メインアプリケーションクラス
├── config.js               # 設定値管理
├── locationService.js      # 現在位置取得サービス
├── pinService.js           # ピン管理サービス
├── bottomSheet.js          # モバイル向けボトムシートの開閉ユーティリティ
├── utils.js                # ユーティリティ関数
├── styles.css              # スタイル定義（ボトムシート/ポップアップ含む）
├── data/                   # CSVデータファイル（開発用）
├── public/
│   └── data/               # CSVデータファイル（本番用）
│       ├── barrier_free_toilets.csv
│       ├── station_barrier_free_toilets.csv
│       └── tokyo/          # 東京都全域データ
│           ├── 23ku/       # 23区データ（30ファイル）
│           ├── tama/       # 多摩地域データ（28ファイル）
│           ├── islands/    # 島嶼部データ（52ファイル）
│           └── tokyo_station/  # 駅施設データ
├── dist/                   # ビルド済みファイル
│   ├── index.html
│   ├── assets/
│   └── data/              # ビルド済みデータ
├── package.json           # パッケージ設定
├── vite.config.js         # Vite設定
└── node_modules/          # Node.js依存関係
```

### クラス設計

- **MapApp**: メインアプリケーション管理
- **LocationService**: 現在位置取得機能
- **PinService**: ピン配置・管理、CSV データ読み込み
- **BottomSheet（ユーティリティ）**: ボトムシートの開閉・イベント制御（`bottomSheet.js`）
- **CONFIG**: 設定値の一元管理

### データ仕様

- **データソース**: 東京都全域のバリアフリートイレ施設データ（CSV 形式）
- **カバー地域**: 23 区、多摩地域、島嶼部（伊豆諸島、小笠原諸島含む）
- **データファイル数**: 135 以上の自治体別 CSV ファイル
- **データ区分**: 一般施設データ + 駅施設データ
- **検索範囲**: 現在位置から 500m 以内
- **表示制限**: 最大 50 件
- **座標系**: WGS84（緯度・経度）
- **データ構造**: 住所、施設名、階数、設備詳細、緯度経度

## 環境設定

### 必要な環境変数

```
VITE_MAPTILER_API_KEY=your_maptiler_api_key
TOKYO_STATION_LNG=139.767
TOKYO_STATION_LAT=35.681
DEFAULT_ZOOM=15
CURRENT_LOCATION_ZOOM=15
```

### セットアップ

```bash
# 依存関係のインストール
npm install

# 開発サーバー起動
npm run dev

# プロダクションビルド
npm run build

# プレビュー
npm run preview
```

## 開発・運用

### 開発環境

- **ES6 Modules**: モジュール化アーキテクチャ
- **Vite**: 高速な開発サーバーとビルドツール
- **位置情報機能**: HTTPS 環境でのテストが必要
- **データ管理**: public/data/ に本番用データを配置

### プロジェクト構造

- **開発用データ**: `/data/` - 開発時のデータ配置
- **本番用データ**: `/public/data/` - ビルド時にコピーされるデータ
- **ビルド済み**: `/dist/` - Vite ビルド後の静的ファイル
- **ドキュメント**: `/document/` - 展開・セキュリティ・実装計画書

### データ運用

- CSV ファイルは自治体別に分割管理
- 23 区：30 ファイル、多摩地域：28 ファイル、島嶼部：52 ファイル
- 合計 135 以上のデータファイルで東京都全域をカバー

### ビルド・展開

```bash
# 開発サーバー起動
npm run dev

# 本番ビルド（データファイル自動コピー）
npm run build

# ビルド結果プレビュー
npm run preview
```

## 仕様詳細（モバイルのボトムシート）

- DOM 構造: `index.html` にバックドロップ（透明）とボトムシートのコンテナを追加
  - `#bottom-sheet`（`role="dialog" aria-modal="true"`）、`#bottom-sheet-backdrop`（透明・非ブロッキング）
- スタイル: `styles.css` に `#bottom-sheet`, `#bottom-sheet-backdrop`, `.bs-header`, `.bs-body`, `body.bs-lock` を定義
- ロジック: `bottomSheet.js` で `isMobile() / openBottomSheet() / closeBottomSheet() / bindBottomSheetEvents()` を提供
  - 背景の暗幕は使用しません（透明バックドロップ）。地図操作は継続可能
  - 外側クリックはドキュメントキャプチャで検出しクローズ（パン/ピンチはクローズしません）
- 連携: `pinService.js` のマーカークリックで、モバイルはボトムシートを開き、デスクトップは従来のポップアップを使用
- 地図空白クリック: `app.js` で地図クリック時にボトムシートもクローズ（モバイル時）

## カスタマイズ

- モバイル判定の閾値: `bottomSheet.js` の `isMobile()`（`(max-width: 768px)`）を調整
- シート高さ: `styles.css` の `#bottom-sheet { height: 50dvh; }` を変更
- ピンの縦位置オフセット（モバイル）: `pinService.js` 内の `desiredFromTop = 1 - 0.65` の 0.65 を変更
- 外側クリックで閉じない運用: `bottomSheet.js` の外側クリック検出（`document.addEventListener('click', ...)`）を無効化
- 背景の暗幕を戻す: `#bottom-sheet-backdrop` の `background: transparent;` を半透明色に変更し、必要に応じて `pointer-events` を有効化

## アクセシビリティ

- `#bottom-sheet` に `role="dialog"`、`aria-modal="true"` を付与
- 開いた際にクローズボタンへ初期フォーカスを移動、閉じたら元のフォーカスに復帰
- シート表示中は `body.bs-lock` で背面のページスクロールを抑制（地図のパン/ズームは可能）

## 変更履歴（UI関連）

- モバイルでピン詳細をポップアップからボトムシート表示へ変更（背景の暗幕なし）
- ボトムシート表示中でも地図の操作（パン/ピンチズーム）を可能に変更
- ピン選択時、モバイルではピンが画面下から約 65% の位置に来るようにカメラ位置を調整

## ライセンス

このプロジェクトは MIT ライセンスの下で公開されています。
